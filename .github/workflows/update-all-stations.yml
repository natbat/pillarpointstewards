name: Update all stations

on:
  workflow_dispatch:
  schedule:
    # Every Monday at 8am UTC
    - cron: '0 8 * * 1'

permissions:
  contents: write

jobs:
  scheduled:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Trigger station update and save response
      env:
        BACKUP_SECRET: ${{ secrets.BACKUP_SECRET }}
      run: |-
        stations=$(curl -s https://www.tidepoolstewards.com/update-stations/)
        # Loop through each station in the counts
        echo "$stations" | jq -r '.counts | keys[]' | while read -r station_id; do
            echo "Processing station $station_id"
            # POST request for each station
            HTTP_STATUS=$(curl -s -w "%{http_code}" \
              -X POST \
              -d "station_id=$station_id" \
              https://www.tidepoolstewards.com/update-stations/)
            if [ $HTTP_STATUS -ge 400 ]; then
                echo "Error: Server returned status $HTTP_STATUS for station $station_id"
                exit 1
            fi
            echo "Successfully processed station $station_id"
        done

    - name: Commit and push if there are changes
      run: |-
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add update-all-stations.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update stations data [skip ci]" && git push)
